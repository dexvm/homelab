---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: snapshot-operator
  annotations:
    policies.kyverno.io/title: Snapshot Operator
    policies.kyverno.io/subject: PersistentVolumeClaim
    policies.kyverno.io/description: |
      This policy creates a Kopia snapshot CronJob for labeled PersistentVolumeClaims
spec:
  generateExistingOnPolicyUpdate: true
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: create-cronjob
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  snapshot.home.arpa/enabled: "true"
                  app.kubernetes.io/name: "*"
                  app.kubernetes.io/instance: "*"
      context:
        - name: appName
          variable:
            jmesPath: "request.object.metadata.labels.\"app.kubernetes.io/name\""
        - name: instanceName
          variable:
            jmesPath: "request.object.metadata.labels.\"app.kubernetes.io/instance\""
        - name: claimName
          variable:
            jmesPath: "request.object.metadata.name"
        - name: namespace
          variable:
            jmesPath: "request.object.metadata.namespace"
      generate:
        synchronize: true
        apiVersion: batch/v1
        kind: CronJob
        name: "{{ appName }}-{{ claimName }}-snapshot"
        namespace: "{{ namespace }}"
        data:
          metadata:
            labels:
              app.kubernetes.io/name: "{{ appName }}"
              app.kubernetes.io/instance: "{{ instanceName }}"
            ownerReferences:
              - apiVersion: "{{ request.object.apiVersion }}"
                kind: "{{ request.object.kind }}"
                name: "{{ request.object.metadata.name }}"
                uid: "{{ request.object.metadata.uid }}"
          spec:
            schedule: "0 3 * * *"
            suspend: false
            concurrencyPolicy: Forbid
            successfulJobsHistoryLimit: 1
            failedJobsHistoryLimit: 2
            jobTemplate:
              spec:
                ttlSecondsAfterFinished: 86400 # 24h
                template:
                  spec:
                    automountServiceAccountToken: false
                    restartPolicy: OnFailure
                    # Stagger jobs to run randomly within X seconds to avoid bringing down all apps at once
                    initContainers:
                      - name: wait
                        image: ghcr.io/onedr0p/alpine:3.16.1@sha256:ed7edf90c1e7df516ff37267841a17d0bedf7ef873f8f81bb3ddf06b3a464d06
                        command: ["/scripts/sleep.sh"]
                        args: ["1", "900"]
                    containers:
                      - name: snapshot
                        image: ghcr.io/onedr0p/kopia:0.11.3@sha256:37e10143585ff2e668a10d878d854831e92bfb7f482f823d1f58af3910fcff41
                        env:
                          - name: KOPIA_CACHE_DIRECTORY
                            value: /snapshots/{{ namespace }}/{{ appName }}/{{ claimName }}/cache
                          - name: KOPIA_LOG_DIR
                            value: /snapshots/{{ namespace }}/{{ appName }}/{{ claimName }}/logs
                          - name: KOPIA_PASSWORD
                            value: "${SECRET_KOPIA_PASSWORD}"
                        command:
                          - /bin/bash
                          - -c
                          - |-
                            echo "[01/08] Create repo ..."           && [[ ! -f /snapshots/kopia.repository.f ]] && kopia repository create filesystem --path=/snapshots
                            echo "[02/08] Connect to repo ..."       && kopia repo connect filesystem --path=/snapshots --override-hostname=cluster --override-username=root
                            echo "[03/08] Set policies ..."          && kopia policy set /data/{{ namespace }}/{{ appName }}/{{ claimName }} --compression=zstd --keep-latest 14 --keep-hourly 0 --keep-daily 0 --keep-weekly 0 --keep-monthly 0 --keep-annual 0
                            echo "[04/08] Snapshot ..."              && kopia snap create /data/{{ namespace }}/{{ appName }}/{{ claimName }}
                            echo "[05/08] List snapshots ..."        && kopia snap list /data/{{ namespace }}/{{ appName }}/{{ claimName }}
                            echo "[06/08] Show stats ..."            && kopia content stats
                            echo "[07/08] Show maintenance info ..." && kopia maintenance info
                            echo "[08/08] Disconnect from repo ..."  && kopia repo disconnect
                        volumeMounts:
                          - name: data
                            mountPath: "/data/{{ namespace }}/{{ appName }}/{{ claimName }}"
                          - name: snapshots
                            mountPath: /snapshots
                        securityContext:
                          privileged: true
                    volumes:
                      - name: data
                        persistentVolumeClaim:
                          claimName: "{{ claimName }}"
                      - name: snapshots
                        nfs:
                          server: "${NAS_ADDR}"
                          path: /volume1/backups/kopia
