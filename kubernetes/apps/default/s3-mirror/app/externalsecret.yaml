---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: s3-mirror-secret
  namespace: default
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: doppler
  target:
    template:
      engineVersion: v2
      data:
        MINIO_CNPG_BUCKET: "{{ .MINIO_CNPG_BUCKET }}"
        B2_CNPG_BUCKET: "{{ .B2_CNPG_BUCKET }}"
        MINIO_LONGHORN_BUCKET: "{{ .MINIO_LONGHORN_BUCKET }}"
        B2_LONGHORN_BUCKET: "{{ .B2_LONGHORN_BUCKET }}"
        rclone.conf: |
          [minio]
          type = s3
          provider = Minio
          access_key_id = {{ .MINIO_CRONJOB_USER }}
          secret_access_key = {{ .MINIO_CRONJOB_PASS }}
          endpoint = http://{{ .MINIO_HOST }}

          [backblaze]
          type = b2
          account = {{ .B2_CRONJOB_USER }}
          key = {{ .B2_CRONJOB_PASS }}
          hard_delete = true

          [backblaze-crypt]
          type = crypt
          remote = backblaze:
          filename_encryption = off
          directory_name_encryption = false
          password = {{ .BACKBLAZE_CRYPT_PASS }}
          password2 = {{ .BACKBLAZE_CRYPT_PASS2 }}
  dataFrom:
    - extract:
        key: MINIO
    - extract:
        key: BACKBLAZE
    - extract:
        key: RCLONE_BACKUP
